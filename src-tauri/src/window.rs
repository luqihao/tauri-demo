use tauri::Manager;

/// çª—å£ç®¡ç†ç›¸å…³åŠŸèƒ½æ¨¡å—
///
/// æä¾›çª—å£æ˜¾ç¤ºã€éšè—ã€æ ‡é¢˜æ›´æ–°ç­‰åŠŸèƒ½
/// è¿™ä¸ªæ¨¡å—å°è£…äº†ä¸çª—å£æ“ä½œç›¸å…³çš„æ‰€æœ‰é€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç 

/// æ›´æ–°çª—å£æ ‡é¢˜æ˜¾ç¤ºæœªè¯»æ•°
///
/// è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®æœªè¯»æ¶ˆæ¯æ•°é‡æ¥åŠ¨æ€æ›´æ–°ä¸»çª—å£çš„æ ‡é¢˜
/// å¦‚æœæœ‰æœªè¯»æ¶ˆæ¯ï¼Œä¼šåœ¨æ ‡é¢˜ä¸­æ˜¾ç¤ºçº¢è‰²åœ†ç‚¹å’Œæœªè¯»æ•°é‡
/// å¦‚æœæ²¡æœ‰æœªè¯»æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ™®é€šçš„åº”ç”¨æ ‡é¢˜
///
/// # å‚æ•°
/// - `app`: Tauri åº”ç”¨å¥æŸ„
/// - `count`: æœªè¯»æ¶ˆæ¯æ•°é‡
///
/// # è¿”å›å€¼
/// - `Ok(())`: æ“ä½œæˆåŠŸ
/// - `Err(String)`: æ“ä½œå¤±è´¥ï¼ŒåŒ…å«é”™è¯¯ä¿¡æ¯
pub fn update_window_title(app: &tauri::AppHandle, count: u32) -> Result<(), String> {
    // æ›´æ–°çª—å£æ ‡é¢˜æ˜¾ç¤ºæœªè¯»æ•°
    // ä½¿ç”¨å·¥å…·å‡½æ•°è·å–ä¸»çª—å£ï¼Œé¿å…é‡å¤çš„çª—å£è·å–é€»è¾‘
    if let Some(window) = app.get_webview_window("main") {
        // æ ¹æ®æœªè¯»æ•°é‡åˆ›å»ºä¸åŒçš„çª—å£æ ‡é¢˜
        let window_title = if count > 0 {
            format!("ğŸ”´ Demo ({} æ¡æœªè¯»)", count)
        } else {
            "Demo".to_string()
        };
        // è®¾ç½®çª—å£æ ‡é¢˜ï¼Œå¿½ç•¥å¯èƒ½çš„é”™è¯¯
        // è¿™é‡Œä½¿ç”¨ let _ = æ˜¯å› ä¸ºçª—å£æ ‡é¢˜è®¾ç½®å¤±è´¥é€šå¸¸ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½
        let _ = window.set_title(&window_title);
    }
    Ok(())
}

/// æ˜¾ç¤ºä¸»çª—å£å¹¶è®¾ç½®ç„¦ç‚¹
///
/// è¿™ä¸ªå‡½æ•°ç”¨äºæ˜¾ç¤ºä¸»çª—å£å¹¶å°†å…¶ç½®äºå‰å°
/// é€šå¸¸åœ¨ç”¨æˆ·ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡æˆ– Dock å›¾æ ‡æ—¶è°ƒç”¨
///
/// # å‚æ•°
/// - `app`: Tauri åº”ç”¨å¥æŸ„
pub fn show_main_window(app: &tauri::AppHandle) {
    // è·å–åä¸º "main" çš„ WebView çª—å£
    // get_webview_window è¿”å› Option<WebviewWindow>
    if let Some(window) = app.get_webview_window("main") {
        println!("æ˜¾ç¤ºä¸»çª—å£å¹¶è®¾ç½®ç„¦ç‚¹");
        // show() æ˜¾ç¤ºçª—å£ï¼Œå¦‚æœçª—å£å·²ç»æ˜¾ç¤ºåˆ™æ— æ•ˆæœ
        let _ = window.show();
        // set_focus() å°†ç„¦ç‚¹è®¾ç½®åˆ°çª—å£ï¼Œä½¿å…¶æˆä¸ºæ´»åŠ¨çª—å£
        let _ = window.set_focus();
        // unminimize() å¦‚æœçª—å£è¢«æœ€å°åŒ–åˆ™å–æ¶ˆæœ€å°åŒ–
        let _ = window.unminimize();
        println!("ä¸»çª—å£å·²æ˜¾ç¤ºå¹¶è·å¾—ç„¦ç‚¹");
    } else {
        println!("è­¦å‘Šï¼šæ— æ³•æ‰¾åˆ°åä¸º 'main' çš„çª—å£");
    }
}

/// éšè—ä¸»çª—å£
///
/// è¿™ä¸ªå‡½æ•°ç”¨äºéšè—ä¸»çª—å£è€Œä¸å…³é—­åº”ç”¨ç¨‹åº
/// éšè—ååº”ç”¨ç¨‹åºç»§ç»­åœ¨åå°è¿è¡Œï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿæ‰˜ç›˜æˆ– Dock å›¾æ ‡è®¿é—®
///
/// # å‚æ•°
/// - `app`: Tauri åº”ç”¨å¥æŸ„
pub fn hide_main_window(app: &tauri::AppHandle) {
    if let Some(window) = app.get_webview_window("main") {
        println!("éšè—ä¸»çª—å£");
        // hide() éšè—çª—å£ä½†ä¸å…³é—­åº”ç”¨ç¨‹åº
        // è¿™ä¸ close() ä¸åŒï¼Œclose() ä¼šå…³é—­çª—å£å¹¶å¯èƒ½é€€å‡ºåº”ç”¨
        let _ = window.hide();
        println!("ä¸»çª—å£å·²éšè—");
    } else {
        println!("è­¦å‘Šï¼šæ— æ³•æ‰¾åˆ°åä¸º 'main' çš„çª—å£");
    }
}

/// åˆ‡æ¢ä¸»çª—å£æ˜¾ç¤ºçŠ¶æ€
///
/// è¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥ä¸»çª—å£å½“å‰çš„å¯è§æ€§çŠ¶æ€ï¼š
/// - å¦‚æœçª—å£å½“å‰å¯è§ï¼Œåˆ™éšè—å®ƒ
/// - å¦‚æœçª—å£å½“å‰éšè—ï¼Œåˆ™æ˜¾ç¤ºå¹¶è®¾ç½®ç„¦ç‚¹
///
/// è¿™æ˜¯ç”¨æˆ·ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡æ—¶çš„å¸¸è§è¡Œä¸º
///
/// # å‚æ•°
/// - `app`: Tauri åº”ç”¨å¥æŸ„
pub fn toggle_main_window(app: &tauri::AppHandle) {
    if let Some(window) = app.get_webview_window("main") {
        // æ£€æŸ¥çª—å£æ˜¯å¦å¯è§
        // is_visible() è¿”å› Result<bool, Error>
        // unwrap_or(false) è¡¨ç¤ºå¦‚æœè·å–å¯è§æ€§çŠ¶æ€å¤±è´¥ï¼Œåˆ™å‡è®¾çª—å£ä¸å¯è§
        if window.is_visible().unwrap_or(false) {
            // çª—å£å½“å‰å¯è§ï¼Œéšè—å®ƒ
            hide_main_window(app);
        } else {
            // çª—å£å½“å‰éšè—ï¼Œæ˜¾ç¤ºå®ƒ
            show_main_window(app);
        }
    }
}
